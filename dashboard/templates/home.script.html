{# {% load static %} #}

{# <script type="text/javascript" src="{% static "serialize-0.2.min.js" %}"></script> #}
<script type="text/javascript">
    var djangoHelpers =
    {
        getCookie : function(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        },

        ajaxUpdate : function(_type = "POST", _url, _datatype = 'application/json', _data, _success, _fail)
        {
            var xhr = new XMLHttpRequest();
            var csrftoken = djangoHelpers.getCookie('csrftoken');

            xhr.open(_type, _url);
            xhr.setRequestHeader('Content-Type', _datatype);
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
            xhr.onload = function() {
                xhr.status === 200 ? _success(xhr.status, xhr.responseText) : _fail(xhr.status, xhr.responseText);
            };

            if (_datatype === 'application/json') _data = JSON.stringify(_data);
            xhr.send(_data);

            return xhr;
        },

        serializeForm: function(_form)
        {
            // https://gomakethings.com/how-to-serialize-form-data-with-vanilla-js/
            // https://github.com/jquery/jquery/blob/669f720edc4f557dfef986db747c09ebfaa16ef5/src/serialize.js
            // Loop through form elements
            var _data = {};
            const rsubmitterTypes = /^(?:submit|button|image|reset|file)$/i

            for (let i = 0; i < _form.elements.length; i++) {
                let field = _form.elements[i];

                // We skip fields without a name, submits, buttons, file and reset inputs
                if (!field.name || rsubmitterTypes.test(field.type)) continue;

                // If a multi-select, get all selections
                if (field.type === 'select-multiple') {
                    _data[field.name] = []
                    if (!field.disabled)
                    {
                        for (let n = 0; n < field.options.length; n++) {
                            if (!field.options[n].selected) continue;
                            _data[field.name].push(field.options[n].value);
                        }
                    }
                }
                // If checkbox, we convert to 1 and 0
                // in ternary: _data[field.name] = (!field.disabled) ? field.checked & 1 : 0;
                else if (field.type === 'checkbox') _data[field.name] = (field.checked ^ field.disabled) & !field.disabled
                // Default
                else _data[field.name] = (!field.disabled) ? field.value : 0;
            }

            return _data;
        }
    }

    document.addEventListener('DOMContentLoaded', function(e) {
        // Initialization
        // Disable all disabled buttons
        d_btns = document.querySelectorAll(".disabled a");
        d_btns.forEach(function(ele) {
            ele.addEventListener('click', e => e.preventDefault() );
        });
        // Initialize collapsibles
        var _collapsibles = document.querySelectorAll('.collapsible');
        var instances = M.Collapsible.init(_collapsibles, false);

        // AJAX for change in done-status
        _checkboxes = document.querySelectorAll(".coy-section");
        _checkboxes.forEach(function(ele) {
            ele.addEventListener('change', function(e) {

                _data = djangoHelpers.serializeForm(e.target.form);
                console.log(_data);

                // TODO: Handle the AJAX
                djangoHelpers.ajaxUpdate( "POST", "/update/", 'application/json', JSON.stringify(_data),
                    function(status, response) {
                        // Success
                        console.log(response);
                        console.log("AJAX update success");
                    },
                    function(status, response) {
                        // Fail
                        console.log("AJAX update failed");
                    }
                );

            });
        });
    });
</script>
